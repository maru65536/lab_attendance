# Lab Attendance App

ç ”ç©¶å®¤æ»åœ¨æ™‚é–“ã‚’å¯è¦–åŒ–ã™ã‚‹Webã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³

## ç¾åœ¨ã®çŠ¶æ…‹

âœ… **ç¨¼åƒä¸­**: https://maru65536.com/lab_attendance/  
âœ… **iPhoneé€£æº**: ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆã‚¢ãƒ—ãƒªå¯¾å¿œ  
âœ… **è‡ªå‹•æ›´æ–°**: 30ç§’ã”ã¨ã«ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°  
âœ… **é€²è¡Œä¸­ã‚»ãƒƒã‚·ãƒ§ãƒ³**: åœ¨å®¤ä¸­ã¯ç¾åœ¨æ™‚åˆ»ã¾ã§ã®ãƒãƒ¼è¡¨ç¤º  
ğŸ”§ **æ—¢çŸ¥ã®å•é¡Œ**: ã‚¹ãƒãƒ›ã§ã®ã€Œe is not a functionã€ã‚¨ãƒ©ãƒ¼ï¼ˆPCãƒ»ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆã¯æ­£å¸¸å‹•ä½œï¼‰

## æ§‹æˆ

- **Backend**: FastAPI + SQLite
- **Frontend**: Next.js 10.2.3 + React 17 + TypeScript
- **Infrastructure**: AWS EC2 (t2.micro) + Terraform + nginx + Cloudflare SSL

## æ©Ÿèƒ½

### ğŸ“Š å¯è¦–åŒ–æ©Ÿèƒ½
- **æ¨ªãƒãƒ¼å½¢å¼**: 1æ—¥ã®æ»åœ¨æ™‚é–“ã‚’24æ™‚é–“è»¸ã®æ¨ªãƒãƒ¼ã§è¡¨ç¤º
- **30æ—¥åˆ†è¡¨ç¤º**: éå»30æ—¥é–“ã®ãƒ‡ãƒ¼ã‚¿ã‚’æ–°ã—ã„æ—¥ãŒä¸Šã‹ã‚‰è¡¨ç¤º
- **ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°**: 30ç§’ã”ã¨ã«è‡ªå‹•æ›´æ–°
- **é€²è¡Œä¸­ã‚»ãƒƒã‚·ãƒ§ãƒ³**: åœ¨å®¤ä¸­ã¯ç¾åœ¨æ™‚åˆ»ã¾ã§ã®ç·‘è‰²ãƒãƒ¼ã‚’ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ è¡¨ç¤º
- **è©³ç´°ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—**: ãƒãƒ¼ã«ãƒã‚¦ã‚¹ã‚ªãƒ¼ãƒãƒ¼ã§æ™‚åˆ»ãƒ»æ»åœ¨æ™‚é–“ã‚’è¡¨ç¤º

### ğŸ“± iPhoneé€£æº
- **ãƒ¯ãƒ³ã‚¿ãƒƒãƒ—å…¥é€€å®¤**: ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆã‚¢ãƒ—ãƒªã‹ã‚‰ç°¡å˜è¨˜éŒ²
- **é‡è¤‡é˜²æ­¢**: åŒã˜ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã®é€£ç¶šå®Ÿè¡Œã‚’è‡ªå‹•ã§ç„¡è¦–
- **å³åº§åæ˜ **: è¨˜éŒ²å¾Œã™ãã«Webã§ç¢ºèªå¯èƒ½

### ğŸ”§ æŠ€è¡“çš„ç‰¹å¾´
- **ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–ãƒ‡ã‚¶ã‚¤ãƒ³**: PCãƒ»ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆãƒ»ã‚¹ãƒãƒ›å¯¾å¿œ
- **JSTè¡¨ç¤º**: æ—¥æœ¬æ™‚é–“ã§ã®æ­£ç¢ºãªæ™‚åˆ»è¡¨ç¤º
- **SQLite**: è»½é‡ã§é«˜é€Ÿãªãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹
- **SSLå¯¾å¿œ**: HTTPSæ¥ç¶šã§ã‚»ã‚­ãƒ¥ã‚¢

## iPhoneé€£æº

iPhoneã®ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆã‚¢ãƒ—ãƒªã‹ã‚‰ä»¥ä¸‹ã®URLã«GETãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡ï¼š

- å…¥å®¤: `https://maru65536.com/lab_attendance/api/lab-entry?action=enter`
- é€€å®¤: `https://maru65536.com/lab_attendance/api/lab-entry?action=exit`

## ãƒ‡ãƒ—ãƒ­ã‚¤

### å‰ææ¡ä»¶
- AWS CLIè¨­å®šæ¸ˆã¿
- Terraform ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ¸ˆã¿
- SSHéµ (`~/.ssh/id_ed25519`) è¨­å®šæ¸ˆã¿
- Cloudflareã§ãƒ‰ãƒ¡ã‚¤ãƒ³è¨­å®šæ¸ˆã¿ï¼ˆSSL: Flexible ãƒ¢ãƒ¼ãƒ‰ï¼‰

### ä¸€ç™ºãƒ‡ãƒ—ãƒ­ã‚¤
```bash
./deploy.sh
```

### æ‰‹å‹•ãƒ‡ãƒ—ãƒ­ã‚¤

#### 1. ã‚¤ãƒ³ãƒ•ãƒ©æ§‹ç¯‰ (åˆå›ã®ã¿)
```bash
cd terraform
terraform init
terraform plan
terraform apply
```

**æ³¨æ„**: `terraform output`ã§EC2ã®IPã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’ç¢ºèªã—ã€ä»¥ä¸‹ã®æ‰‹é †ã§ä½¿ç”¨ã—ã¦ãã ã•ã„ã€‚

#### 2. ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒ‡ãƒ—ãƒ­ã‚¤

**Current EC2 IP**: `3.115.30.125`

```bash
# Backend
scp -i ~/.ssh/id_ed25519 -r backend/ ec2-user@3.115.30.125:/home/ec2-user/lab_attendance/
ssh -i ~/.ssh/id_ed25519 ec2-user@3.115.30.125 << 'EOF'
cd lab_attendance/backend
pkill -f "uvicorn main:app" || true
pip3 install --user -r requirements.txt
nohup python3 -m uvicorn main:app --host 127.0.0.1 --port 8000 > /tmp/backend.log 2>&1 &
EOF

# Frontend
scp -i ~/.ssh/id_ed25519 -r frontend/ ec2-user@3.115.30.125:/home/ec2-user/lab_attendance/
ssh -i ~/.ssh/id_ed25519 ec2-user@3.115.30.125 << 'EOF'
cd lab_attendance/frontend
pkill -f "next dev" || true
rm -rf .next node_modules
PATH=/usr/local/node/bin:$PATH npm install --no-optional
PATH=/usr/local/node/bin:$PATH nohup npm run dev -- -H 127.0.0.1 > /tmp/frontend.log 2>&1 &
EOF

# Nginx (åˆå›ã®ã¿)
scp -i ~/.ssh/id_ed25519 nginx-maru65536.conf ec2-user@3.115.30.125:/tmp/
ssh -i ~/.ssh/id_ed25519 ec2-user@3.115.30.125 << 'EOF'
sudo amazon-linux-extras install nginx1 -y
sudo cp /tmp/nginx-maru65536.conf /etc/nginx/conf.d/
sudo nginx -t
sudo systemctl start nginx
sudo systemctl enable nginx
EOF
```

## ã‚¢ã‚¯ã‚»ã‚¹

- **Website**: https://maru65536.com/lab_attendance/
- **API**: https://maru65536.com/lab_attendance/api/status

## é–‹ç™ºç’°å¢ƒã®åˆ¶ç´„

- Node.js 12.22.9ã‚’ä½¿ç”¨ï¼ˆAmazon Linux 2ã®GLIBCåˆ¶ç´„ã®ãŸã‚ï¼‰
- Next.js 10.2.3ã‚’ä½¿ç”¨ï¼ˆNode.js 12å¯¾å¿œã®ãŸã‚ï¼‰
- React 17ã‚’ä½¿ç”¨ï¼ˆNext.js 10å¯¾å¿œã®ãŸã‚ï¼‰

## ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

### ãƒ—ãƒ­ã‚»ã‚¹ç¢ºèª
```bash
ssh -i ~/.ssh/id_ed25519 ec2-user@3.115.30.125 'ps aux | grep -E "(uvicorn|next)" | grep -v grep'
```

### ãƒãƒ¼ãƒˆç¢ºèª
```bash
ssh -i ~/.ssh/id_ed25519 ec2-user@3.115.30.125 'netstat -tlnp | grep -E ":(3000|8000)"'
```

### ã‚µãƒ¼ãƒ“ã‚¹çŠ¶æ…‹ç¢ºèª
```bash
ssh -i ~/.ssh/id_ed25519 ec2-user@3.115.30.125 'sudo systemctl status nginx'
curl -I https://maru65536.com/lab_attendance/
curl https://maru65536.com/lab_attendance/api/status
```

### ãƒ­ã‚°ç¢ºèª
```bash
ssh -i ~/.ssh/id_ed25519 ec2-user@3.115.30.125 'tail -f /tmp/backend.log'
ssh -i ~/.ssh/id_ed25519 ec2-user@3.115.30.125 'tail -f /tmp/frontend.log'
ssh -i ~/.ssh/id_ed25519 ec2-user@3.115.30.125 'sudo tail -f /var/log/nginx/error.log'
```

### ã‚ˆãã‚ã‚‹å•é¡Œã¨å¯¾å‡¦æ³•

#### Node.js ãƒãƒ¼ã‚¸ãƒ§ãƒ³å•é¡Œ
```bash
# Node.js 12.22.9 ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ç¢ºèª
ssh -i ~/.ssh/id_ed25519 ec2-user@3.115.30.125 '/usr/local/node/bin/node --version'

# æ‰‹å‹•ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ï¼ˆå¿…è¦ã«å¿œã˜ã¦ï¼‰
ssh -i ~/.ssh/id_ed25519 ec2-user@3.115.30.125 << 'EOF'
cd /tmp
wget https://nodejs.org/download/release/v12.22.9/node-v12.22.9-linux-x64.tar.gz
tar -xzf node-v12.22.9-linux-x64.tar.gz
sudo mkdir -p /usr/local/node
sudo mv node-v12.22.9-linux-x64/* /usr/local/node/
EOF
```

#### ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã‚­ãƒ£ãƒƒã‚·ãƒ¥å•é¡Œ
```bash
ssh -i ~/.ssh/id_ed25519 ec2-user@3.115.30.125 << 'EOF'
cd lab_attendance/frontend
pkill -f "next dev" || true
rm -rf .next node_modules
PATH=/usr/local/node/bin:$PATH npm install --no-optional
PATH=/usr/local/node/bin:$PATH nohup npm run dev -- -H 127.0.0.1 > /tmp/frontend.log 2>&1 &
EOF
```

## APIä»•æ§˜

### POST /api/lab-entry
å…¥é€€å®¤è¨˜éŒ²ã‚’ä¿å­˜

**Request Body:**
```json
{
  "action": "enter" | "exit"
}
```

### GET /api/lab-entry?action=enter|exit
å…¥é€€å®¤è¨˜éŒ²ã‚’ä¿å­˜ï¼ˆiPhoneç”¨ï¼‰

### GET /api/attendance-data?days=30
éå»30æ—¥é–“ã®æ»åœ¨ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—

### GET /api/status
ç¾åœ¨ã®æ»åœ¨çŠ¶æ³ã‚’å–å¾—

